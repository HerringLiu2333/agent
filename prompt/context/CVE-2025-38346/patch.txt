    @@ -7438,9 +7438,10 @@ void ftrace_release_mod(struct module *mod)
     
     	mutex_lock(&ftrace_lock);
     
    -	if (ftrace_disabled)
    -		goto out_unlock;
    -
    +	/*
    +	 * To avoid the UAF problem after the module is unloaded, the
    +	 * 'mod_map' resource needs to be released unconditionally.
    +	 */
     	list_for_each_entry_safe(mod_map, n, &ftrace_mod_maps, list) {
     		if (mod_map->mod == mod) {
     			list_del_rcu(&mod_map->list);
    @@ -7449,6 +7450,9 @@ void ftrace_release_mod(struct module *mod)
     		}
     	}
     
    +	if (ftrace_disabled)
    +		goto out_unlock;
    +
     	/*
     	 * Each module has its own ftrace_pages, remove
     	 * them from the list.