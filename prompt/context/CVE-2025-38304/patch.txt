    @@ -366,17 +366,19 @@ u8 eir_create_scan_rsp(struct hci_dev *hdev, u8 instance, u8 *ptr)
     
     void *eir_get_service_data(u8 *eir, size_t eir_len, u16 uuid, size_t *len)
     {
    -	while ((eir = eir_get_data(eir, eir_len, EIR_SERVICE_DATA, len))) {
    +	size_t dlen;
    +
    +	while ((eir = eir_get_data(eir, eir_len, EIR_SERVICE_DATA, &dlen))) {
     		u16 value = get_unaligned_le16(eir);
     
     		if (uuid == value) {
     			if (len)
    -				*len -= 2;
    +				*len = dlen - 2;
     			return &eir[2];
     		}
     
    -		eir += *len;
    -		eir_len -= *len;
    +		eir += dlen;
    +		eir_len -= dlen;
     	}
     
     	return NULL;