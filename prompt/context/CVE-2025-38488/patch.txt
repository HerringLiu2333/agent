     @@ -4316,6 +4316,7 @@ crypt_message(struct TCP_Server_Info *server, int num_rqst,
      	u8 key[SMB3_ENC_DEC_KEY_SIZE];
      	struct aead_request *req;
      	u8 *iv;
     +	DECLARE_CRYPTO_WAIT(wait);
      	unsigned int crypt_len = le32_to_cpu(tr_hdr->OriginalMessageSize);
      	void *creq;
      	size_t sensitive_size;
     @@ -4366,7 +4367,11 @@ crypt_message(struct TCP_Server_Info *server, int num_rqst,
      	aead_request_set_crypt(req, sg, sg, crypt_len, iv);
      	aead_request_set_ad(req, assoc_data_len);
     
     -	rc = enc ? crypto_aead_encrypt(req) : crypto_aead_decrypt(req);
     +	aead_request_set_callback(req, CRYPTO_TFM_REQ_MAY_BACKLOG,
     +				  crypto_req_done, &wait);
     +
     +	rc = crypto_wait_req(enc ? crypto_aead_encrypt(req)
     +				: crypto_aead_decrypt(req), &wait);
     
      	if (!rc && enc)
      		memcpy(&tr_hdr->Signature, sign, SMB2_SIGNATURE_SIZE);