1. CVE Identifier
CVE-2024-57978

2. Vulnerability Type
Error pointer dereference (ERR_PTR misuse) leading to kernel crash/Oops.

3. Root Cause Summary
The detach path in mxc_jpeg_detach_pm_domains used a NULL-only check before passing jpeg->pd_dev[i] to pm_runtime_suspended(). If jpeg->pd_dev[i] held an ERR_PTR, the condition “jpeg->pd_dev[i]” evaluated true and pm_runtime_suspended() was called with an invalid pointer, causing an Oops. The first branch lacked IS_ERR/IS_ERR_OR_NULL validation, unlike the other branches, resulting in inconsistent and unsafe handling of error pointers.

4. Kernel Subsystem Analysis
1) Affected Subsystem:
Linux media subsystem, NXP i.MX JPEG driver (drivers/media/platform/nxp/imx-jpeg), power management domain detach and runtime PM.

2) Pre-Patch Flaw:
In mxc_jpeg_detach_pm_domains(), the code used “if (jpeg->pd_dev[i] && !pm_runtime_suspended(jpeg->pd_dev[i]))” without checking for ERR_PTR values, allowing an error pointer to be passed to pm_runtime_suspended().

3) Trigger Condition:
jpeg->pd_dev[i] is set to an ERR_PTR (not NULL), and mxc_jpeg_detach_pm_domains() is executed, causing the first if-condition to pass and pm_runtime_suspended(jpeg->pd_dev[i]) to be invoked with an error pointer.

4) Impact Mechanism:
pm_runtime_suspended() expects a valid struct device pointer; receiving an ERR_PTR leads to invalid memory access and kernel Oops, resulting in a crash/DoS during PM domain detach.

5. Patch Analysis
1) Fix Approach:
Strengthen pointer validation by converting all checks on jpeg->pd_dev[i] and jpeg->pd_link[i] to IS_ERR_OR_NULL, ensuring runtime PM and device link/domain APIs are only called with valid pointers.

2) Key Code Changes:
- Replaced “if (jpeg->pd_dev[i] && !pm_runtime_suspended(jpeg->pd_dev[i]))” with “if (!IS_ERR_OR_NULL(jpeg->pd_dev[i]) && !pm_runtime_suspended(jpeg->pd_dev[i]))” to guard pm_runtime_suspended() against ERR_PTR.
- Replaced “if (jpeg->pd_link[i] && !IS_ERR(jpeg->pd_link[i]))” with “if (!IS_ERR_OR_NULL(jpeg->pd_link[i]))” before device_link_del().
- Replaced “if (jpeg->pd_dev[i] && !IS_ERR(jpeg->pd_dev[i]))” with “if (!IS_ERR_OR_NULL(jpeg->pd_dev[i]))” before dev_pm_domain_detach().

3) Locking/Concurrency Impact:
No locking or ordering changes; the patch solely improves pointer validation. Runtime PM operations continue as before, but are now gated on valid pointers, eliminating unsafe calls.

6. Broader Kernel Security Implications
Consistent use of IS_ERR_OR_NULL prevents invalid pointer dereferences in PM cleanup paths, improving kernel robustness against error-path-induced crashes. It reinforces a best practice across drivers: arrays or fields that may contain ERR_PTR must be validated before use. By avoiding Oops in teardown, the patch reduces denial-of-service risk and stabilizes power management interactions within the media subsystem.